<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot IAM - Assistant Intelligent</title>
    <!-- Tailwind CSS CDN pour un stylisme moderne et r√©actif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome pour les ic√¥nes -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
/* Reset et styles de base */
 :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-glow: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.1);
            --animation-speed: 0.3s;
        }

        /* Animation des particules flottantes */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            overflow: hidden;
        }

        .floating-particles::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            animation: particleFloat 20s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        /* Header avec effet glassmorphism */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-glow);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            -webkit-text-fill-color: #667eea;
            background: none;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-type-selector {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            color: white;
            outline: none;
            transition: all var(--animation-speed);
        }

        .user-type-selector:focus {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
            border-color: #667eea;
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Boutons avec effets modernes */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all var(--animation-speed);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-soft);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Container principal */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            position: relative;
        }

        /* Sidebar avec animations */
        .sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 2rem;
            overflow-y: auto;
            transition: transform var(--animation-speed);
        }

        .sidebar h3 {
            color: white;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 0.5rem;
            padding: 1rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all var(--animation-speed);
            cursor: pointer;
        }

        .feature-list li:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            box-shadow: var(--shadow-soft);
        }

        .feature-list li i {
            color: #667eea;
            margin-right: 0.5rem;
        }

        /* Chat container avec design moderne */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.03);
        }

        .chat-header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
        }

        .chat-header small {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #00f2fe;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 242, 254, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 242, 254, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 242, 254, 0); }
        }

        /* Messages avec bulles modernes */
        .chat-messages {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: messageSlideIn 0.5s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bot-avatar {
            background: var(--primary-gradient);
            color: white;
        }

        .user-avatar {
            background: var(--secondary-gradient);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            position: relative;
        }

        .bot-message {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        /* Actions rapides */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .quick-action {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all var(--animation-speed);
            font-size: 0.9rem;
        }

        .quick-action:hover {
            background: var(--primary-gradient);
            transform: scale(1.05);
        }

        /* Indicateur de frappe */
        .typing-indicator {
            display: none;
            padding: 0 2rem;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            align-items: center;
            gap: 0.5rem;
        }

        .typing-dots {
            display: inline-flex;
            gap: 0.2rem;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #667eea;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Zone de saisie moderne */
        .chat-input-container {
            padding: 1.5rem 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: end;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 0.5rem;
            transition: all var(--animation-speed);
        }

        .chat-input-wrapper:focus-within {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            padding: 0.75rem 1rem;
            resize: none;
            max-height: 120px;
            font-size: 1rem;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--animation-speed);
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Modals avec glassmorphism */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-glow);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .modal-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all var(--animation-speed);
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        /* Formulaires stylis√©s */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: white;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            outline: none;
            transition: all var(--animation-speed);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.1);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Tables avec design moderne */
        .admin-panel-content table {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            overflow: hidden;
        }

        .admin-panel-content th {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            font-weight: 600;
        }

        .admin-panel-content td {
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-panel-content tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Sidebar d'historique */
        .history-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            transition: right var(--animation-speed);
            z-index: 200;
            display: flex;
            flex-direction: column;
        }

        .history-sidebar.open {
            right: 0;
        }

        .history-sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-sidebar-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-sidebar-content {
            flex: 1;
            padding: 1rem 2rem;
            overflow-y: auto;
        }

        /* Statistiques color√©es */
        .admin-panel-content .bg-blue-50 { background: rgba(59, 130, 246, 0.1) !important; }
        .admin-panel-content .bg-green-50 { background: rgba(34, 197, 94, 0.1) !important; }
        .admin-panel-content .bg-yellow-50 { background: rgba(245, 158, 11, 0.1) !important; }
        .admin-panel-content .bg-purple-50 { background: rgba(147, 51, 234, 0.1) !important; }

        /* Responsive design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .user-menu {
                width: 100%;
                justify-content: space-between;
            }

            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                order: 2;
            }

            .chat-container {
                order: 1;
                height: 60vh;
            }

            .message-content {
                max-width: 85%;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }

            .history-sidebar {
                width: 100%;
                right: -100%;
            }
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-gradient);
        }

        /* Animations de chargement */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* √âtats d'interaction */
        .interactive:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <!-- Particules flottantes -->
    <div class="floating-particles" id="particles"></div>

    <!-- En-t√™te principal -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            Chatbot IAM
        </div>
        <div class="user-menu">
            <!-- S√©lecteur de type d'utilisateur -->
            <select class="user-type-selector" id="userType">
                <option value="prospect">üë§ Prospect</option>
                <option value="student">üéì √âtudiant</option>
                <option value="admin">‚öôÔ∏è Administrateur</option>
            </select>
            <!-- Boutons d'authentification -->
            <div class="auth-buttons">
                <button class="btn btn-secondary" onclick="openModal('loginModal')">
                    <i class="fas fa-sign-in-alt"></i> Connexion
                </button>
                <button class="btn btn-primary" onclick="openModal('registerModal')">
                    <i class="fas fa-user-plus"></i> Inscription
                </button>
            </div>
        </div>
    </header>

    <!-- Conteneur principal de l'application -->
    <div class="main-container">
        <!-- Barre lat√©rale de navigation -->
        <aside class="sidebar">
            <h3>
                <i class="fas fa-list-ul"></i>
                <span id="sidebarTitle">Fonctionnalit√©s Prospects</span>
            </h3>
            <ul class="feature-list" id="featureList">
                <!-- Contenu dynamique g√©n√©r√© par JS -->
            </ul>
        </aside>

        <!-- Conteneur de chat principal -->
        <main class="chat-container">
            <!-- En-t√™te du chat -->
            <div class="chat-header">
                <div>
                    <h2>Assistant IAM</h2>
                    <small id="userTypeDisplay">Mode Prospect</small>
                </div>
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>En ligne</span>
                </div>
                <!-- Bouton pour ouvrir la barre lat√©rale d'historique -->
                <button class="btn btn-secondary !px-4 !py-2 !rounded-full" onclick="toggleHistorySidebar()">
                    <i class="fas fa-history mr-2"></i> Historique
                </button>
            </div>

            <!-- Zone des messages de chat -->
            <div class="chat-messages" id="chatMessages">
                <!-- Message initial du bot -->
                <div class="message">
                    <div class="message-avatar bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content bot-message">
                        <p>Bonjour ! Je suis votre assistant IAM. Comment puis-je vous aider aujourd'hui ?</p>
                        <div class="quick-actions" id="quickActions">
                            <!-- Actions rapides dynamiques g√©n√©r√©es par JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicateur de saisie du bot -->
            <div class="typing-indicator" id="typingIndicator">
                L'assistant tape
                <span class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </div>

            <!-- Zone de saisie du message -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea
                        class="chat-input"
                        id="messageInput"
                        placeholder="Tapez votre message..."
                        rows="1"></textarea>
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals de connexion et d'inscription -->

    <!-- Modal de connexion -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Connexion</h3>
                <button class="close-modal" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Mot de passe</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
            </form>
        </div>
    </div>

    <!-- Modal d'inscription -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Inscription</h3>
                <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Nom complet</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPhone">T√©l√©phone</label>
                    <input type="tel" id="registerPhone" required>
                </div>
                <div class="form-group">
                    <label for="registerType">Type d'utilisateur</label>
                    <select id="registerType" required>
                        <option value="">S√©lectionner...</option>
                        <option value="prospect">Prospect</option>
                        <option value="student">√âtudiant</option>
                        <!-- Les administrateurs ne peuvent pas s'inscrire via ce formulaire -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Mot de passe</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-user-plus"></i> S'inscrire
                </button>
            </form>
        </div>
    </div>

    <!-- Modals et Sections pour les Fonctionnalit√©s Admin -->

    <!-- Modal de gestion des utilisateurs -->
    <div class="modal" id="manageUsersModal">
        <div class="modal-content max-w-2xl">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i> Gestion des Utilisateurs</h3>
                <button class="close-modal" onclick="closeModal('manageUsersModal')">&times;</button>
            </div>
            <div class="admin-panel-content">
                <button class="btn btn-primary mb-4" onclick="openModal('addUserModal')">Ajouter un nouvel utilisateur</button>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-blue-100 text-blue-800 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">Nom</th>
                                <th class="py-3 px-6 text-left">Email</th>
                                <th class="py-3 px-6 text-left">Type</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Les utilisateurs seront charg√©s ici via JS -->
                            <tr><td colspan="5" class="py-4 text-center">Chargement des utilisateurs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter/√©diter un utilisateur -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addUserModalTitle"><i class="fas fa-user-plus"></i> Ajouter un utilisateur</h3>
                <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userIdToEdit">
                <div class="form-group">
                    <label for="userName">Nom complet</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userPhone">T√©l√©phone</label>
                    <input type="tel" id="userPhone">
                </div>
                <div class="form-group">
                    <label for="userTypeSelect">Type d'utilisateur</label>
                    <select id="userTypeSelect" required>
                        <option value="prospect">Prospect</option>
                        <option value="student">√âtudiant</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                <div class="form-group" id="userPasswordGroup">
                    <label for="userPassword">Mot de passe</label>
                    <input type="password" id="userPassword">
                </div>
                <button type="submit" class="btn btn-primary w-full"><i class="fas fa-save"></i> Enregistrer l'utilisateur</button>
            </form>
        </div>
    </div>

    <!-- Modal de gestion des r√©clamations -->
    <div class="modal" id="manageReclamationsModal">
        <div class="modal-content max-w-2xl">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> Gestion des R√©clamations</h3>
                <button class="close-modal" onclick="closeModal('manageReclamationsModal')">&times;</button>
            </div>
            <div class="admin-panel-content">
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-yellow-100 text-yellow-800 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">ID</th>
                                <th class="py-3 px-6 text-left">Utilisateur</th>
                                <th class="py-3 px-6 text-left">Type</th>
                                <th class="py-3 px-6 text-left">Priorit√©</th>
                                <th class="py-3 px-6 text-left">Statut</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reclamationsTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Les r√©clamations seront charg√©es ici via JS -->
                            <tr><td colspan="6" class="py-4 text-center">Chargement des r√©clamations...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal des statistiques du chatbot -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> Statistiques du Chatbot</h3>
                <button class="close-modal" onclick="closeModal('statsModal')">&times;</button>
            </div>
            <div class="admin-panel-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg shadow-md border border-blue-200">
                    <h4 class="text-lg font-semibold text-blue-700 mb-2">Total Utilisateurs</h4>
                    <p id="totalUsersCount" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow-md border border-green-200">
                    <h4 class="text-lg font-semibold text-green-700 mb-2">Messages envoy√©s</h4>
                    <p id="totalMessagesCount" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow-md border border-yellow-200">
                    <h4 class="text-lg font-semibold text-yellow-700 mb-2">R√©clamations en attente</h4>
                    <p id="pendingReclamationsCount" class="text-3xl font-bold text-yellow-600">0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg shadow-md border border-purple-200">
                    <h4 class="text-lg font-semibold text-purple-700 mb-2">Administrateurs</h4>
                    <p id="adminUsersCount" class="text-3xl font-bold text-purple-600">0</p>
                </div>
                <!-- Plus de stats peuvent √™tre ajout√©es ici -->
            </div>
        </div>
    </div>

    <!-- Nouvelle barre lat√©rale pour l'historique du chat -->
    <div class="history-sidebar" id="historySidebar">
        <div class="history-sidebar-header">
            <h3><i class="fas fa-history"></i> Historique des conversations</h3>
            <button class="close-modal text-white hover:text-gray-300" onclick="toggleHistorySidebar()">&times;</button>
        </div>
        <!-- Bouton Nouvelle conversation -->
        <button class="btn btn-primary bg-green-600 hover:bg-green-700 w-full mb-4" onclick="createNewConversation()">
            <i class="fas fa-plus-circle mr-2"></i> Nouvelle conversation
        </button>
        <div class="history-sidebar-content" id="conversationsList">
            <!-- La liste des conversations sera charg√©e ici -->
            <p class="text-gray-400 text-center py-4">Connectez-vous pour voir l'historique.</p>
        </div>
    </div>

    <script>
        // Configuration des fonctionnalit√©s par type d'utilisateur
        const userFeatures = {
            prospect: {
                title: 'Fonctionnalit√©s Prospects',
                display: 'Mode Prospect',
                features: [
                    { icon: 'fas fa-book', text: 'Informations formations', action: 'getFormations' },
                    { icon: 'fas fa-euro-sign', text: 'Prix et modalit√©s', action: 'getPricing' },
                    { icon: 'fas fa-file-alt', text: 'Processus inscription', action: 'getInscription' },
                    { icon: 'fas fa-map-marker-alt', text: 'Contact et localisation', action: 'getContact' },
                    { icon: 'fas fa-envelope', text: 'Demande d\'information', action: 'requestInfo' },
                    { icon: 'fas fa-user-plus', text: 'Pr√©-inscription', action: 'preRegister' }
                ],
                quickActions: [
                    'Voir les formations',
                    'Tarifs 2025',
                    'Comment s\'inscrire ?',
                    'Prendre rendez-vous'
                ]
            },
            student: {
                title: 'Espace √âtudiant',
                display: 'Mode √âtudiant',
                features: [
                    { icon: 'fas fa-chart-line', text: 'Mes notes', action: 'getGrades' },
                    { icon: 'fas fa-credit-card', text: 'Suivi paiements', action: 'getPayments' },
                    { icon: 'fas fa-exclamation-circle', text: 'R√©clamations', action: 'getReclamations' },
                    { icon: 'fas fa-calendar', text: 'Emploi du temps', action: 'getSchedule' },
                    { icon: 'fas fa-book-open', text: 'Ressources p√©dagogiques', action: 'getResources' },
                    { icon: 'fas fa-comments', text: 'Contact administration', action: 'contactAdmin' }
                ],
                quickActions: [
                    'Mes derni√®res notes',
                    '√âtat des paiements',
                    'Cr√©er une r√©clamation',
                    'Emploi du temps'
                ]
            },
            admin: {
                title: 'Panel Administrateur',
                display: 'Mode Administrateur',
                features: [
                    { icon: 'fas fa-users', text: 'Gestion utilisateurs', action: 'openManageUsersModal' },
                    { icon: 'fas fa-chart-bar', text: 'Statistiques chatbot', action: 'openStatsModal' },
                    { icon: 'fas fa-tasks', text: 'Gestion r√©clamations', action: 'openManageReclamationsModal' },
                    { icon: 'fas fa-cog', text: 'Configuration r√©ponses', action: 'configureBot' },
                    { icon: 'fas fa-bell', text: 'Notifications syst√®me', action: 'getNotifications' },
                    { icon: 'fas fa-database', text: 'Sauvegarde donn√©es', action: 'backupData' }
                ],
                quickActions: [
                    'G√©rer les utilisateurs',
                    'Voir les statistiques',
                    'R√©clamations en attente',
                    'Configurer le bot'
                ]
            }
        };

        let currentUserType = 'prospect';
        let isLoggedIn = false;
        let currentUser = null; // Stockera { id, name, email, type, token }
        // Historique de chat pour le LLM
        let chatHistory = [{ role: "model", parts: [{ text: "Bonjour ! Je suis votre assistant IAM. Comment puis-je vous aider aujourd'hui ?" }] }];
        let currentConversationId = null; // ID de la conversation actuelle

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            // Tente de charger l'utilisateur depuis sessionStorage au d√©marrage
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    isLoggedIn = true;
                    currentUserType = currentUser.type;
                    updateAuthInterface();
                    // Assure que l'interface est mise √† jour apr√®s le chargement de l'utilisateur
                    updateUserInterface();
                    // Charge la conversation initiale si l'utilisateur est connect√©
                    createOrLoadInitialConversation();
                } catch (e) {
                    console.error("Erreur de parsing de currentUser depuis sessionStorage:", e);
                    // Nettoyer si le stockage est corrompu
                    sessionStorage.removeItem('currentUser');
                }
            } else {
                updateUserInterface(); // Met √† jour l'interface pour le mode prospect par d√©faut
            }
            setupEventListeners();
        });

        /**
         * Configure tous les √©couteurs d'√©v√©nements pour l'interface.
         */
        function setupEventListeners() {
            // √âv√©nement pour le changement de type d'utilisateur
            document.getElementById('userType').addEventListener('change', function(e) {
                // Si l'utilisateur change manuellement de type, le d√©connecter d'abord
                if (isLoggedIn && currentUserType !== e.target.value) {
                    logout(); // D√©connexion automatique si le r√¥le est chang√© manuellement
                    showNotification("Vous avez √©t√© d√©connect√© pour changer de r√¥le.", 'info');
                }
                currentUserType = e.target.value;
                updateUserInterface();
                // Efface l'historique du chat lors du changement de r√¥le pour un nouveau contexte
                chatHistory = [{ role: "model", parts: [{ text: `Bienvenue en mode ${userFeatures[currentUserType].display}. Comment puis-je vous aider ?` }] }];
                document.getElementById('chatMessages').innerHTML = ''; // Vide les messages
                addMessage(userFeatures[currentUserType].quickActions.join(', '), 'bot'); // Affiche des actions rapides de bienvenue
            });

            // Auto-redimensionnement de la textarea de message
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Envoi du message par la touche Entr√©e (sans Shift)
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Soumission des formulaires de connexion et d'inscription
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('userForm').addEventListener('submit', handleUserFormSubmit); // Pour ajouter/√©diter utilisateur

            // Fermeture des modals en cliquant √† l'ext√©rieur
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        /**
         * Met √† jour l'interface utilisateur en fonction du type d'utilisateur s√©lectionn√©.
         */
        function updateUserInterface() {
            const config = userFeatures[currentUserType];

            // Met √† jour le titre de la barre lat√©rale et le texte d'affichage du mode
            document.getElementById('sidebarTitle').innerHTML = `<i class="fas fa-list-ul"></i> ${config.title}`;
            document.getElementById('userTypeDisplay').textContent = config.display;

            // G√©n√®re et met √† jour la liste des fonctionnalit√©s
            const featureList = document.getElementById('featureList');
            featureList.innerHTML = config.features.map(feature =>
                `<li onclick="executeAction('${feature.action}')">
                    <i class="${feature.icon}"></i>
                    ${feature.text}
                </li>`
            ).join('');

            // G√©n√®re et met √† jour les actions rapides
            const quickActions = document.getElementById('quickActions');
            quickActions.innerHTML = config.quickActions.map(action =>
                `<span class="quick-action" onclick="sendQuickMessage('${action}')">${action}</span>`
            ).join('');

            // Mettre √† jour le s√©lecteur de type d'utilisateur en fonction du currentUser
            const userTypeSelector = document.getElementById('userType');
            if (isLoggedIn && currentUser && currentUser.type) {
                userTypeSelector.value = currentUser.type;
                userTypeSelector.disabled = true; // D√©sactiver le s√©lecteur si connect√©
            } else {
                userTypeSelector.value = currentUserType; // Revenir au type s√©lectionn√© si d√©connect√©
                userTypeSelector.disabled = false;
            }
        }

        /**
         * Envoie un message de l'utilisateur au chatbot et g√®re la r√©ponse.
         */
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            let message = input.value.trim();

            if (!message) return;

            // --- Logique d'interception des actions directes ---
            if (message.toLowerCase().includes('prendre rendez-vous')) {
                if (isLoggedIn && currentUser) {
                    handleAppointmentScheduling(); // Appelle directement la fonction pour le formulaire
                    input.value = '';
                    input.style.height = 'auto';
                    return; // Stoppe l'ex√©cution, pas besoin d'appeler le LLM
                } else {
                    showNotification("Veuillez vous connecter pour prendre un rendez-vous.", 'warning');
                    openModal('loginModal');
                    input.value = '';
                    input.style.height = 'auto';
                    return; // Stoppe l'ex√©cution
                }
            } else if (message.toLowerCase().includes('cr√©er une r√©clamation') || message.toLowerCase().includes('faire une r√©clamation')) {
                 if (isLoggedIn && currentUser) {
                    handleComplaintFiling(); // Appelle directement la fonction pour le formulaire de r√©clamation
                    input.value = '';
                    input.style.height = 'auto';
                    return; // Stoppe l'ex√©cution
                } else {
                    showNotification("Veuillez vous connecter pour d√©poser une r√©clamation.", 'warning');
                    openModal('loginModal');
                    input.value = '';
                    input.style.height = 'auto';
                    return; // Stoppe l'ex√©cution
                }
            }


            addMessage(message, 'user');
            chatHistory.push({ role: "user", parts: [{ text: message }] });

            showTypingIndicator();

            try {
                // Si c'est le premier message d'une nouvelle conversation (currentConversationId est null),
                // nous le cr√©erons sur le backend au moment de l'enregistrement du message.
                // Le conversationId sera ensuite renvoy√© par le backend.
                let tempConversationId = currentConversationId;

                // ENREGISTREMENT DU MESSAGE UTILISATEUR VIA BACKEND PHP
                if (isLoggedIn && currentUser) {
                    const sendMsgResponse = await fetch('/chatbot_iam/api/chat.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentUser.token}`
                        },
                        body: JSON.stringify({
                            action: 'sendMessage',
                            userId: currentUser.id,
                            message: message,
                            sender: 'user',
                            conversationId: tempConversationId // Peut √™tre null
                        })
                    });
                    const sendMsgResult = await sendMsgResponse.json();
                    if (sendMsgResult.success) {
                        // Si une nouvelle conversation a √©t√© cr√©√©e, mettez √† jour l'ID local
                        if (!tempConversationId && sendMsgResult.conversationId) {
                            currentConversationId = sendMsgResult.conversationId;
                            // Recharger la liste des conversations pour afficher la nouvelle
                            fetchConversations();
                        }
                    } else {
                        console.error('Erreur lors de l\'enregistrement du message utilisateur:', sendMsgResult.message);
                        showNotification("Le message de l'utilisateur n'a pas pu √™tre enregistr√© sur le serveur.", 'warning');
                    }
                }

                // Appel √† l'API Gemini pour g√©n√©rer la r√©ponse du bot
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAP2MKpsQAitsbTwQMSQ0G0_HeeeftGTIU"; // <--- CLE API MISE A JOUR ICI !
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                let botResponseText = "D√©sol√©, une erreur est survenue lors de la r√©cup√©ration de ma r√©ponse. Veuillez r√©essayer plus tard.";
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                } else {
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        botResponseText = result.candidates[0].content.parts[0].text;
                    }
                }

                addMessage(botResponseText, 'bot');
                chatHistory.push({ role: "model", parts: [{ text: botResponseText }] });

                // ENREGISTREMENT DE LA R√âPONSE DU BOT VIA BACKEND PHP
                if (isLoggedIn && currentUser && currentConversationId) {
                    try {
                        await fetch('/chatbot_iam/api/chat.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentUser.token}`
                            },
                            body: JSON.stringify({
                                action: 'sendMessage',
                                userId: currentUser.id,
                                message: botResponseText,
                                sender: 'bot',
                                conversationId: currentConversationId
                            })
                        });
                    } catch (error) {
                        console.error('Erreur lors de l\'enregistrement du message du bot:', error);
                        showNotification("La r√©ponse du bot n'a pas pu √™tre enregistr√©e.", 'warning');
                    }
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                showNotification("Il semble y avoir un probl√®me de connexion avec le service d'IA.", 'error');
            } finally {
                hideTypingIndicator();
                input.value = ''; // Efface le message apr√®s l'envoi
                input.style.height = 'auto'; // R√©initialise la hauteur
            }
        }

        /**
         * Envoie un message rapide g√©n√©r√© par un clic sur une action rapide.
         * @param {string} message - Le message √† envoyer.
         */
        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        /**
         * Ajoute un message √† la zone de chat.
         * @param {string} content - Le contenu du message.
         * @param {string} sender - Le type d'exp√©diteur ('user' ou 'bot').
         */
        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatarClass = sender === 'user' ? 'user-avatar' : 'bot-avatar';
            const avatarIcon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
            const messageClass = sender === 'user' ? 'user-message' : 'bot-message';

            messageDiv.innerHTML = `
                <div class="message-avatar ${avatarClass}">
                    <i class="${avatarIcon}"></i>
                </div>
                <div class="message-content ${messageClass}">
                    <p>${content}</p>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // D√©file vers le bas
        }

        /**
         * Ex√©cute une action sp√©cifique d√©clench√©e par un clic sur une fonctionnalit√© de la sidebar.
         * @param {string} action - L'identifiant de l'action √† ex√©cuter.
         */
        function executeAction(action) {
            // Utilise un objet pour mapper les actions √† leurs fonctions correspondantes
            const actions = {
                // Actions Prospect et √âtudiant (d√©j√† existantes)
                getFormations: () => sendQuickMessage("Quelles sont les formations disponibles ?"),
                getPricing: () => sendQuickMessage("Quels sont vos tarifs ?"),
                getInscription: () => sendQuickMessage("Comment s'inscrire ?"),
                getContact: () => sendQuickMessage("O√π √™tes-vous situ√©s ?"),
                requestInfo: () => showNotification("Fonctionnalit√© 'Demande d\'information' √† impl√©menter. Un formulaire modal pourrait appara√Ætre ici.", 'info'),
                preRegister: () => showNotification("Fonctionnalit√© 'Pr√©-inscription' √† impl√©menter. Un formulaire modal pourrait appara√Ætre ici.", 'info'),
                getGrades: () => sendQuickMessage("Afficher mes notes"),
                getPayments: () => sendQuickMessage("√âtat de mes paiements"),
                getReclamations: () => sendQuickMessage("Mes r√©clamations"),
                getSchedule: () => sendQuickMessage("Mon emploi du temps"),
                getResources: () => sendQuickMessage("Ressources p√©dagogiques"),
                contactAdmin: () => sendQuickMessage("Contacter l'administration"),

                // Actions Administrateur
                openManageUsersModal: () => {
                    if (isLoggedIn && currentUser.type === 'admin') {
                        openModal('manageUsersModal');
                        fetchUsers(); // Charger les utilisateurs lors de l'ouverture de la modal
                    } else {
                        showNotification("Acc√®s refus√©. Seuls les administrateurs peuvent g√©rer les utilisateurs.", 'error');
                    }
                },
                openStatsModal: () => {
                    if (isLoggedIn && currentUser.type === 'admin') {
                        openModal('statsModal');
                        fetchStats(); // Charger les stats lors de l'ouverture de la modal
                    } else {
                        showNotification("Acc√®s refus√©. Seuls les administrateurs peuvent voir les statistiques.", 'error');
                    }
                },
                openManageReclamationsModal: () => {
                    if (isLoggedIn && currentUser.type === 'admin') {
                        openModal('manageReclamationsModal');
                        fetchReclamations(); // Charger les r√©clamations lors de l'ouverture de la modal
                    } else {
                        showNotification("Acc√®s refus√©. Seuls les administrateurs peuvent g√©rer les r√©clamations.", 'error');
                    }
                },
                configureBot: () => showNotification("Fonctionnalit√© 'Configuration du bot' √† impl√©menter. N√©cessite une interface d'administration.", 'info'),
                getNotifications: () => showNotification("Fonctionnalit√© 'Notifications syst√®me' √† impl√©menter.", 'info'),
                backupData: () => showNotification("Fonctionnalit√© 'Sauvegarde des donn√©es' √† impl√©menter. N√©cessite un acc√®s serveur direct.", 'info')
            };

            if (actions[action]) {
                actions[action]();
            } else {
                showNotification(`Action "${action}" non reconnue ou non impl√©ment√©e.`, 'warning');
            }
        }

        /**
         * Affiche l'indicateur de saisie du bot.
         */
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Masque l'indicateur de saisie du bot.
         */
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        /**
         * Ouvre une modal sp√©cifi√©e.
         * @param {string} modalId - L'ID de la modal √† ouvrir.
         */
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        /**
         * Ferme une modal sp√©cifi√©e.
         * @param {string} modalId - L'ID de la modal √† fermer.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        /**
         * G√®re le processus de connexion en appelant le backend PHP.
         * @param {Event} e - L'√©v√©nement de soumission du formulaire.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/chatbot_iam/api/auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, action: 'login' })
                });
                const result = await response.json();

                if (result.success) {
                    isLoggedIn = true;
                    currentUser = result.user; // Le backend renvoie les infos de l'utilisateur
                    currentUserType = currentUser.type;
                    
                    // NOUVEAU: Stocke l'utilisateur dans sessionStorage pour persistance entre pages
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

                    updateAuthInterface();
                    updateUserInterface();
                    closeModal('loginModal');
                    showNotification(`Bienvenue ${currentUser.name} ! Vous √™tes maintenant connect√© en tant que ${userFeatures[currentUserType].display}.`, 'success');

                    // Cr√©er/charger la conversation par d√©faut ou la derni√®re conversation
                    await createOrLoadInitialConversation();

                    // Mettre √† jour la liste des conversations dans la sidebar
                    fetchConversations();

                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showNotification("Erreur de communication avec le serveur. Assurez-vous que le backend PHP est en cours d'ex√©cution et accessible.", 'error');
            }
        }

        /**
         * G√®re le processus d'inscription en appelant le backend PHP.
         * @param {Event} e - L'√©v√©nement de soumission du formulaire.
         */
        async function handleRegister(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('registerName').value,
                email: document.getElementById('registerEmail').value,
                phone: document.getElementById('registerPhone').value,
                type: document.getElementById('registerType').value,
                password: document.getElementById('registerPassword').value,
                action: 'register'
            };

            try {
                const response = await fetch('/chatbot_iam/api/auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(result.message + " Veuillez vous connecter maintenant.", 'success');
                    closeModal('registerModal');
                } else {
                    showNotification(result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur d\'inscription:', error);
                showNotification("Erreur de communication avec le serveur. Assurez-vous que le backend PHP est en cours d'ex√©cution et accessible.", 'error');
            }
        }

        /**
         * Met √† jour les boutons d'authentification dans l'en-t√™te.
         */
        function updateAuthInterface() {
            const authButtons = document.querySelector('.auth-buttons');
            if (isLoggedIn) {
                authButtons.innerHTML = `
                    <div class="text-white flex items-center gap-2 mr-4">
                        <i class="fas fa-user"></i> ${currentUser.name}
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>
                `;
            } else {
                authButtons.innerHTML = `
                    <button class="btn btn-secondary" onclick="openModal('loginModal')">
                        <i class="fas fa-sign-in-alt"></i> Connexion
                    </button>
                    <button class="btn btn-primary" onclick="openModal('registerModal')">
                        <i class="fas fa-user-plus"></i> Inscription
                    </button>
                `;
            }
        }

        /**
         * G√®re la d√©connexion de l'utilisateur.
         */
        function logout() {
            isLoggedIn = false;
            currentUser = null;
            currentUserType = 'prospect'; // Revient au mode prospect apr√®s d√©connexion
            currentConversationId = null; // R√©initialise la conversation active
            sessionStorage.removeItem('currentUser'); // Supprime l'utilisateur de sessionStorage
            updateAuthInterface();
            updateUserInterface(); // Mise √† jour de l'interface pour le mode prospect
            showNotification("Vous avez √©t√© d√©connect√©. √Ä bient√¥t !", 'info');
            document.getElementById('chatMessages').innerHTML = `
                <div class="message">
                    <div class="message-avatar bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content bot-message">
                        <p>Bonjour ! Je suis votre assistant IAM. Comment puis-je vous aider aujourd'hui ?</p>
                        <div class="quick-actions" id="quickActions">
                            <!-- Actions rapides dynamiques g√©n√©r√©es par JS -->
                        </div>
                    </div>
                </div>`; // R√©initialise l'affichage du chat
            chatHistory = [{ role: "model", parts: [{ text: "Bonjour ! Je suis votre assistant IAM. Comment puis-je vous aider aujourd'hui ?" }] }]; // R√©initialise l'historique LLM
            document.getElementById('conversationsList').innerHTML = '<p class="text-gray-400 text-center py-4">Connectez-vous pour voir l\'historique.</p>'; // Vide la liste des conversations
            // Ferme la barre lat√©rale d'historique si elle est ouverte lors de la d√©connexion
            document.getElementById('historySidebar').classList.remove('open');
        }

        /**
         * Affiche une notification temporaire.
         * @param {string} message - Le message de la notification.
         * @param {string} type - Le type de notification ('info', 'success', 'warning', 'error').
         */
        function showNotification(message, type = 'info') {
            const notificationsContainer = document.querySelector('body'); // Ajouter √† la fin du body
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification notification-${type}`;
            notificationDiv.innerHTML = `
                <div class="notification-content">
                    <span>${message}</span>
                    <button class="notification-close-btn" onclick="this.closest('.notification').remove()">
                        &times;
                    </button>
                </div>
            `;
            notificationsContainer.appendChild(notificationDiv);

            // Supprime la notification apr√®s 5 secondes
            setTimeout(() => {
                if (notificationDiv.parentElement) {
                    notificationDiv.remove();
                }
            }, 5000);
        }

        /**
         * Cr√©e une nouvelle conversation ou charge la derni√®re conversation existante apr√®s connexion.
         */
        async function createOrLoadInitialConversation() {
            if (!isLoggedIn || !currentUser) return;

            try {
                const response = await fetch(`/chatbot_iam/api/chat.php?action=getConversations&userId=${currentUser.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                if (result.success && result.conversations.length > 0) {
                    // Charger la derni√®re conversation
                    currentConversationId = result.conversations[0].id;
                    await fetchChatHistory(currentUser.id, currentConversationId);
                    showNotification("Derni√®re conversation charg√©e.", 'info');
                } else {
                    // Cr√©er une nouvelle conversation si aucune n'existe
                    await createNewConversation();
                    showNotification("Nouvelle conversation d√©marr√©e.", 'info');
                }
            } catch (error) {
                console.error('Erreur lors du chargement/cr√©ation de la conversation initiale:', error);
                showNotification("Erreur lors du chargement de la conversation. Veuillez rafra√Æchir la page.", 'error');
            }
        }

        /**
         * Cr√©e une nouvelle conversation via l'API et initialise le chat.
         */
        async function createNewConversation() {
            if (!isLoggedIn || !currentUser) {
                showNotification("Veuillez vous connecter pour cr√©er une nouvelle conversation.", 'warning');
                openModal('loginModal');
                return;
            }

            try {
                const response = await fetch('/chatbot_iam/api/chat.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ action: 'createConversation', userId: currentUser.id })
                });
                const result = await response.json();

                if (result.success) {
                    currentConversationId = result.conversationId;
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="message">
                            <div class="message-avatar bot-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content bot-message">
                                <p>Bonjour ! Je suis votre assistant IAM. Comment puis-je vous aider aujourd'hui ?</p>
                                <div class="quick-actions" id="quickActions">
                                    <!-- Actions rapides dynamiques g√©n√©r√©es par JS -->
                                </div>
                            </div>
                        </div>`;
                    chatHistory = [{ role: "model", parts: [{ text: "Bonjour ! Je suis votre assistant IAM. Comment puis-je vous aider aujourd'hui ?" }] }];
                    updateUserInterface(); // Pour rafra√Æchir les actions rapides
                    showNotification("Nouvelle conversation d√©marr√©e.", 'success');
                    fetchConversations(); // Mettre √† jour la liste des conversations
                } else {
                    showNotification('Erreur lors de la cr√©ation de la conversation: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la cr√©ation de la nouvelle conversation:', error);
                showNotification("Erreur de communication avec le serveur pour la nouvelle conversation.", 'error');
            }
        }

        /**
         * R√©cup√®re l'historique du chat pour une conversation sp√©cifique depuis le backend PHP.
         * @param {number} userId - L'ID de l'utilisateur.
         * @param {number} conversationId - L'ID de la conversation √† charger.
         */
        async function fetchChatHistory(userId, conversationId) {
            if (!isLoggedIn || !currentUser) return; // S'assurer que l'utilisateur est connect√©

            try {
                const response = await fetch(`/chatbot_iam/api/chat.php?action=getChatHistory&userId=${userId}&conversationId=${conversationId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('chatMessages').innerHTML = ''; // Effacer le chat principal
                    chatHistory = []; // R√©initialiser l'historique LLM

                    result.history.forEach(msg => {
                        addMessage(msg.message_text, msg.sender);
                        chatHistory.push({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.message_text }] });
                    });
                    currentConversationId = conversationId; // Mettre √† jour l'ID de la conversation active

                    // Mettre √† jour la classe 'active' dans la liste des conversations
                    document.querySelectorAll('.history-item').forEach(item => {
                        if (parseInt(item.dataset.conversationId) === conversationId) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                } else {
                    showNotification("Impossible de charger l'historique du chat: " + result.message, 'error');
                    console.error("Erreur PHP pour l'historique:", result.message);
                }
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique du chat:', error);
                showNotification("Erreur de connexion lors du chargement de l'historique. Assurez-vous que le backend PHP est en cours d'ex√©cution et accessible.", 'error');
            }
        }

        /**
         * R√©cup√®re la liste des conversations de l'utilisateur et les affiche dans la sidebar d'historique.
         */
        async function fetchConversations() {
            const conversationsListContainer = document.getElementById('conversationsList');
            conversationsListContainer.innerHTML = ''; // Vider avant de remplir

            if (!isLoggedIn || !currentUser) {
                conversationsListContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Connectez-vous pour voir l\'historique.</p>';
                return;
            }

            try {
                const response = await fetch(`/chatbot_iam/api/chat.php?action=getConversations&userId=${currentUser.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                if (result.success && result.conversations.length > 0) {
                    result.conversations.forEach(conv => {
                        const conversationItem = document.createElement('div');
                        conversationItem.className = `history-item ${conv.id === currentConversationId ? 'active' : ''}`;
                        conversationItem.dataset.conversationId = conv.id; // Stocker l'ID de la conversation

                        const date = new Date(conv.start_time).toLocaleDateString('fr-FR', {
                            year: 'numeric', month: 'short', day: 'numeric'
                        });
                        const time = new Date(conv.start_time).toLocaleTimeString('fr-FR', {
                            hour: '2-digit', minute: '2-digit'
                        });

                        conversationItem.innerHTML = `
                            <div class="history-item-details" onclick="loadConversation(${conv.id})">
                                <div class="history-item-title">${conv.title || 'Conversation sans titre'}</div>
                                <div class="history-item-date">${date} ${time}</div>
                            </div>
                            <div class="history-item-actions">
                                <button class="history-action-btn" onclick="renameConversation(${conv.id}, '${conv.title ? conv.title.replace(/'/g, "\\'") : ''}')" title="Renommer">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="history-action-btn" onclick="deleteConversation(${conv.id})" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        conversationsListContainer.appendChild(conversationItem);
                    });
                } else {
                    conversationsListContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Aucune conversation trouv√©e.</p>';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des conversations:', error);
                showNotification("Erreur de communication avec le serveur pour les conversations.", 'error');
            }
        }

        /**
         * Charge une conversation sp√©cifique dans le chat principal.
         * @param {number} conversationId - L'ID de la conversation √† charger.
         */
        async function loadConversation(conversationId) {
            if (currentConversationId === conversationId) {
                // D√©j√† sur cette conversation, ne rien faire
                return;
            }
            if (!isLoggedIn || !currentUser) {
                 showNotification("Veuillez vous connecter pour consulter l'historique.", 'warning');
                 openModal('loginModal');
                 return;
            }
            await fetchChatHistory(currentUser.id, conversationId);
            showNotification(`Conversation ${conversationId} charg√©e.`, 'info');
        }

        /**
         * Renomme une conversation.
         * @param {number} conversationId - L'ID de la conversation √† renommer.
         * @param {string} oldTitle - L'ancien titre pour pr√©-remplir l'input.
         */
        async function renameConversation(conversationId, oldTitle) {
            const newTitle = prompt("Entrez le nouveau titre pour cette conversation:", oldTitle);
            if (newTitle === null || newTitle.trim() === "") {
                showNotification("Renommage annul√© ou titre vide.", 'info');
                return;
            }

            if (!isLoggedIn || !currentUser) {
                showNotification("Vous devez √™tre connect√© pour renommer une conversation.", 'warning');
                return;
            }

            try {
                const response = await fetch('/chatbot_iam/api/chat.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ action: 'renameConversation', conversationId: conversationId, newTitle: newTitle.trim() })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Conversation renomm√©e avec succ√®s !', 'success');
                    fetchConversations(); // Recharger la liste des conversations
                } else {
                    showNotification('Erreur lors du renommage de la conversation: ' + result.message, 'error');
                    console.error("Erreur PHP (renameConversation):", result.message);
                }
            } catch (error) {
                console.error('Erreur lors du renommage de la conversation:', error);
                showNotification("Erreur de communication avec le serveur pour renommer la conversation.", 'error');
            }
        }

        /**
         * Supprime une conversation.
         * @param {number} conversationId - L'ID de la conversation √† supprimer.
         */
        async function deleteConversation(conversationId) {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer cette conversation ? Cette action est irr√©versible.")) {
                return;
            }
             if (!isLoggedIn || !currentUser) {
                showNotification("Vous devez √™tre connect√© pour supprimer une conversation.", 'warning');
                return;
            }

            try {
                const response = await fetch('/chatbot_iam/api/chat.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ action: 'deleteConversation', conversationId: conversationId })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Conversation supprim√©e avec succ√®s !', 'success');
                    // Si la conversation supprim√©e est la conversation active, d√©marrer une nouvelle conversation
                    if (currentConversationId === conversationId) {
                        currentConversationId = null; // R√©initialiser
                        await createNewConversation(); // D√©marrer une nouvelle conversation
                    } else {
                        fetchConversations(); // Sinon, juste rafra√Æchir la liste
                    }
                } else {
                    showNotification('Erreur lors de la suppression de la conversation: ' + result.message, 'error');
                    console.error("Erreur PHP (deleteConversation):", result.message);
                }
            } catch (error) {
                console.error('Erreur lors de la suppression de la conversation:', error);
                showNotification("Erreur de communication avec le serveur pour supprimer la conversation.", 'error');
            }
        }

        /* --- Fonctions Administrateur (inchang√©es) --- */

        /**
         * R√©cup√®re tous les utilisateurs depuis le backend et met √† jour la table.
         */
        async function fetchUsers() {
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour la gestion des utilisateurs.", 'error');
                closeModal('manageUsersModal');
                return;
            }
            try {
                const response = await fetch('/chatbot_iam/api/users_api.php?action=getUsers', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                const usersTableBody = document.getElementById('usersTableBody');
                usersTableBody.innerHTML = ''; // Vider le tableau

                if (result.success && result.users.length > 0) {
                    result.users.forEach(user => {
                        const row = `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${user.id}</td>
                                <td class="py-3 px-6 text-left">${user.name}</td>
                                <td class="py-3 px-6 text-left">${user.email}</td>
                                <td class="py-3 px-6 text-left">${user.phone || 'N/A'}</td>
                                <td class="py-3 px-6 text-left">${user.user_type}</td>
                                <td class="py-3 px-6 text-center">
                                    <div class="flex item-center justify-center">
                                        <button onclick="editUser(${user.id})" class="w-8 h-8 rounded-full bg-blue-200 hover:bg-blue-300 text-blue-700 mx-1 flex items-center justify-center text-lg transform hover:scale-110 transition duration-200">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteUser(${user.id})" class="w-8 h-8 rounded-full bg-red-200 hover:bg-red-300 text-red-700 mx-1 flex items-center justify-center text-lg transform hover:scale-110 transition duration-200">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        usersTableBody.innerHTML += row;
                    });
                } else {
                    usersTableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center">Aucun utilisateur trouv√©.</td></tr>`;
                    if (!result.success) {
                        showNotification("Erreur lors du chargement des utilisateurs: " + result.message, 'error');
                        console.error("Erreur PHP (fetchUsers):", result.message);
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                showNotification("Erreur de communication avec le serveur pour les utilisateurs.", 'error');
            }
        }

        /**
         * Pr√©pare la modal pour l'√©dition d'un utilisateur.
         * @param {number} userId - L'ID de l'utilisateur √† √©diter.
         */
        async function editUser(userId) {
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour l'√©dition des utilisateurs.", 'error');
                return;
            }
            try {
                const response = await fetch(`/chatbot_iam/api/users_api.php?action=getUserById&id=${userId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                if (result.success && result.user) {
                    document.getElementById('addUserModalTitle').textContent = 'Modifier un utilisateur';
                    document.getElementById('userIdToEdit').value = result.user.id;
                    document.getElementById('userName').value = result.user.name;
                    document.getElementById('userEmail').value = result.user.email;
                    document.getElementById('userPhone').value = result.user.phone || '';
                    document.getElementById('userTypeSelect').value = result.user.user_type;
                    document.getElementById('userPasswordGroup').style.display = 'none'; // Cacher le champ mot de passe pour l'√©dition
                    document.getElementById('userPassword').removeAttribute('required'); // Rendre le mot de passe non requis
                    openModal('addUserModal');
                } else {
                    showNotification("Utilisateur non trouv√©: " + result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur pour √©dition:', error);
                showNotification("Erreur de communication avec le serveur pour l'√©dition.", 'error');
            }
        }

        /**
         * Supprime un utilisateur via le backend.
         * @param {number} userId - L'ID de l'utilisateur √† supprimer.
         */
        async function deleteUser(userId) {
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour la suppression des utilisateurs.", 'error');
                return;
            }
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?")) { // Utilisation de confirm pour la d√©mo, remplacer par modal custom en production
                return;
            }
            try {
                const response = await fetch('/chatbot_iam/api/users_api.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ id: userId, action: 'deleteUser' })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    fetchUsers(); // Recharger la liste des utilisateurs
                } else {
                    showNotification("Erreur lors de la suppression de l'utilisateur: " + result.message, 'error');
                    console.error("Erreur PHP (deleteUser):", result.message);
                }
            } catch (error) {
                console.error('Erreur lors de la suppression de l\'utilisateur:', error);
                showNotification("Erreur de communication avec le serveur pour la suppression.", 'error');
            }
        }

        /**
         * G√®re la soumission du formulaire d'ajout/√©dition d'utilisateur.
         */
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour la gestion des utilisateurs.", 'error');
                return;
            }

            const userId = document.getElementById('userIdToEdit').value;
            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                phone: document.getElementById('userPhone').value,
                user_type: document.getElementById('userTypeSelect').value,
            };
            const password = document.getElementById('userPassword').value;

            let method = 'POST';
            let action = 'addUser';

            if (userId) { // Si userId existe, c'est une modification
                method = 'PUT';
                action = 'updateUser';
                userData.id = userId;
                if (password) { // Ajouter le mot de passe seulement s'il est fourni pour une modification
                    userData.password = password;
                }
            } else { // Sinon, c'est un nouvel ajout
                if (!password) {
                    showNotification("Le mot de passe est requis pour un nouvel utilisateur.", 'error');
                    return;
                }
                userData.password = password;
            }

            try {
                const response = await fetch('/chatbot_iam/api/users_api.php', {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ ...userData, action: action })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    closeModal('addUserModal');
                    document.getElementById('userForm').reset(); // R√©initialiser le formulaire
                    document.getElementById('userIdToEdit').value = ''; // R√©initialiser l'ID
                    document.getElementById('userPasswordGroup').style.display = 'block'; // Afficher le champ mot de passe
                    document.getElementById('userPassword').setAttribute('required', 'required'); // Le rendre requis √† nouveau
                    fetchUsers(); // Recharger la liste des utilisateurs
                } else {
                    showNotification("Erreur lors de l'op√©ration: " + result.message, 'error');
                    console.error("Erreur PHP (handleUserFormSubmit):", result.message);
                }
            } catch (error) {
                console.error('Erreur lors de la soumission du formulaire utilisateur:', error);
                showNotification("Erreur de communication avec le serveur pour la gestion des utilisateurs.", 'error');
            }
        }

        /**
         * R√©cup√®re toutes les r√©clamations depuis le backend et met √† jour la table.
         */
        async function fetchReclamations() {
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour la gestion des r√©clamations.", 'error');
                closeModal('manageReclamationsModal');
                return;
            }
            try {
                const response = await fetch('/chatbot_iam/api/reclamations_api.php?action=getReclamations', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                const reclamationsTableBody = document.getElementById('reclamationsTableBody');
                reclamationsTableBody.innerHTML = ''; // Vider le tableau

                if (result.success && result.reclamations.length > 0) {
                    result.reclamations.forEach(rec => {
                        const row = `
                            <tr class="border-b border-gray-200 hover:bg-gray-100">
                                <td class="py-3 px-6 text-left whitespace-nowrap">${rec.id}</td>
                                <td class="py-3 px-6 text-left">${rec.user_email || 'N/A'}</td>
                                <td class="py-3 px-6 text-left">${rec.type}</td>
                                <td class="py-3 px-6 text-left">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${rec.priority === 'urgent' ? 'bg-red-200 text-red-800' : rec.priority === 'high' ? 'bg-orange-200 text-orange-800' : rec.priority === 'medium' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">
                                        ${rec.priority}
                                    </span>
                                </td>
                                <td class="py-3 px-6 text-left">
                                    <select onchange="updateReclamationStatus(${rec.id}, this.value)" class="p-2 border rounded-md shadow-sm">
                                        <option value="open" ${rec.status === 'open' ? 'selected' : ''}>Ouvert</option>
                                        <option value="in_progress" ${rec.status === 'in_progress' ? 'selected' : ''}>En cours</option>
                                        <option value="resolved" ${rec.status === 'resolved' ? 'selected' : ''}>R√©solu</option>
                                        <option value="closed" ${rec.status === 'closed' ? 'selected' : ''}>Ferm√©</option>
                                    </select>
                                </td>
                                <td class="py-3 px-6 text-center">
                                    <button onclick="viewReclamationDetails(${rec.id}, '${rec.description.replace(/'/g, "\\'")}', '${rec.resolution_details ? rec.resolution_details.replace(/'/g, "\\'") : ''}')" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 mx-1 flex items-center justify-center text-lg transform hover:scale-110 transition duration-200">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        reclamationsTableBody.innerHTML += row;
                    });
                } else {
                    reclamationsTableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center">Aucune r√©clamation trouv√©e.</td></tr>`;
                    if (!result.success) {
                        showNotification("Erreur lors du chargement des r√©clamations: " + result.message, 'error');
                        console.error("Erreur PHP (fetchReclamations):", result.message);
                    }
                }
            } catch (error) {
                console.error('Erreur lors du chargement des r√©clamations:', error);
                showNotification("Erreur de communication avec le serveur pour les r√©clamations.", 'error');
            }
        }

        /**
         * Met √† jour le statut d'une r√©clamation via le backend.
         * @param {number} recId - L'ID de la r√©clamation.
         * @param {string} newStatus - Le nouveau statut.
         */
        async function updateReclamationStatus(recId, newStatus) {
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour la mise √† jour des r√©clamations.", 'error');
                return;
            }
            try {
                const response = await fetch('/chatbot_iam/api/reclamations_api.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ id: recId, status: newStatus, action: 'updateStatus' })
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    fetchReclamations(); // Recharger la liste des r√©clamations
                } else {
                    showNotification("Erreur lors de la mise √† jour du statut: " + result.message, 'error');
                    console.error("Erreur PHP (updateReclamationStatus):", result.message);
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du statut de la r√©clamation:', error);
                showNotification("Erreur de communication avec le serveur pour la mise √† jour des r√©clamations.", 'error');
            }
        }

        /**
         * Affiche les d√©tails d'une r√©clamation dans une modal (simple alert pour la d√©mo).
         * En production, cela ouvrirait une modal plus d√©taill√©e.
         * @param {number} id
         * @param {string} description
         * @param {string} resolution_details
         */
        function viewReclamationDetails(id, description, resolution_details) {
            alert(`D√©tails de la r√©clamation #${id}:\n\nDescription: ${description}\n\nD√©tails de r√©solution: ${resolution_details || 'N/A'}`);
        }


        /**
         * R√©cup√®re les statistiques depuis le backend et met √† jour l'interface.
         */
        async function fetchStats() {
            if (!isLoggedIn || currentUser.type !== 'admin') {
                showNotification("Acc√®s non autoris√© pour les statistiques.", 'error');
                closeModal('statsModal');
                return;
            }
            try {
                const response = await fetch('/chatbot_iam/api/stats_api.php?action=getStats', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const result = await response.json();

                if (result.success && result.stats) {
                    document.getElementById('totalUsersCount').textContent = result.stats.totalUsers || '0';
                    document.getElementById('totalMessagesCount').textContent = result.stats.totalMessages || '0';
                    document.getElementById('pendingReclamationsCount').textContent = result.stats.pendingReclamations || '0';
                    document.getElementById('adminUsersCount').textContent = result.stats.adminUsers || '0';
                } else {
                    showNotification("Erreur lors du chargement des statistiques: " + result.message, 'error');
                    console.error("Erreur PHP (fetchStats):", result.message);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                showNotification("Erreur de communication avec le serveur pour les statistiques.", 'error');
            }
        }


        // Ces fonctions (handleAppointmentScheduling, handleComplaintFiling, etc.) sont des exemples de formulaires dynamiques
        // que le bot pourrait "sugg√©rer" d'afficher. Leur soumission devra interagir avec votre backend PHP.

        /**
         * Simule l'affichage d'un formulaire pour prendre un rendez-vous.
         */
        function handleAppointmentScheduling() {
            // S'assurer que l'utilisateur est connect√© pour prendre un rendez-vous
            if (!isLoggedIn || !currentUser) {
                showNotification("Veuillez vous connecter pour prendre un rendez-vous.", 'warning');
                openModal('loginModal'); // Sugg√©rer la connexion
                return;
            }

            const appointmentForm = `
                <div class="bg-blue-50 p-4 rounded-lg mt-4 shadow-sm border border-blue-200">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">üìÖ Prendre un rendez-vous</h4>
                    <form onsubmit="event.preventDefault(); submitAppointment(event);">
                        <div class="form-group">
                            <label for="appointmentDate">Date souhait√©e:</label>
                            <input type="date" id="appointmentDate" class="w-full p-2 border rounded-md" min="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Heure pr√©f√©r√©e:</label>
                            <select id="appointmentTime" class="w-full p-2 border rounded-md" required>
                                <option value="">S√©lectionner...</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentReason">Motif:</label>
                            <textarea id="appointmentReason" rows="3" class="w-full p-2 border rounded-md resize-y" placeholder="D√©crivez bri√®vement le motif de votre rendez-vous..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-4">Confirmer le rendez-vous</button>
                    </form>
                </div>
            `;
            addMessage(`Je vais vous aider √† prendre un rendez-vous. Veuillez remplir les informations ci-dessous :${appointmentForm}`, 'bot');
        }

        /**
         * G√®re la soumission du formulaire de rendez-vous en appelant le backend PHP.
         * @param {Event} event - L'√©v√©nement de soumission.
         */
        async function submitAppointment(event) {
            event.preventDefault();

            if (!isLoggedIn || !currentUser) {
                showNotification("Vous devez √™tre connect√© pour prendre un rendez-vous.", 'warning');
                return;
            }

            const appointmentData = {
                userId: currentUser.id, // L'ID de l'utilisateur connect√©
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                reason: document.getElementById('appointmentReason').value,
                action: 'createAppointment' // Action pour l'API
            };

            try {
                const response = await fetch('/chatbot_iam/api/appointments_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}` // Envoyer le token d'authentification
                    },
                    body: JSON.stringify(appointmentData)
                });
                const result = await response.json();

                if (result.success) {
                    showNotification('Rendez-vous confirm√© ! Vous recevrez une confirmation par email.', 'success');
                    addMessage(`‚úÖ Votre rendez-vous a √©t√© programm√© pour le ${appointmentData.date} √† ${appointmentData.time}. Motif: ${appointmentData.reason}.`, 'bot');
                } else {
                    showNotification('Erreur lors de la confirmation du rendez-vous: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la soumission du rendez-vous:', error);
                showNotification("Erreur de communication avec le serveur pour le rendez-vous. Assurez-vous que le backend PHP est en cours d'ex√©cution et accessible.", 'error');
            }
        }

        /**
         * Simule l'affichage d'un formulaire pour d√©poser une r√©clamation.
         */
        function handleComplaintFiling() {
            if (!isLoggedIn) {
                showNotification("Vous devez √™tre connect√© pour d√©poser une r√©clamation. Veuillez vous connecter d'abord.", 'warning');
                return;
            }

            const complaintForm = `
                <div class="bg-amber-50 p-4 rounded-lg mt-4 shadow-sm border border-amber-200">
                    <h4 class="text-lg font-semibold text-amber-700 mb-3">üìù D√©poser une r√©clamation</h4>
                    <form onsubmit="event.preventDefault(); submitComplaint(event);">
                        <div class="form-group">
                            <label for="complaintType">Type de r√©clamation:</label>
                            <select id="complaintType" class="w-full p-2 border rounded-md" required>
                                <option value="">S√©lectionner...</option>
                                <option value="academic">Probl√®me acad√©mique</option>
                                <option value="administrative">Probl√®me administratif</option>
                                <option value="payment">Probl√®me de paiement</option>
                                <option value="technical">Probl√®me technique</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="complaintPriority">Priorit√©:</label>
                            <select id="complaintPriority" class="w-full p-2 border rounded-md" required>
                                <option value="low">Faible</option>
                                <option value="medium" selected>Moyenne</option>
                                <option value="high">√âlev√©e</option>
                                <option value="urgent">Urgente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="complaintDescription">Description d√©taill√©e:</label>
                            <textarea id="complaintDescription" rows="4" class="w-full p-2 border rounded-md resize-y" placeholder="D√©crivez votre probl√®me en d√©tail..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-4 bg-amber-600 hover:bg-amber-700">Soumettre la r√©clamation</button>
                    </form>
                </div>
            `;
            addMessage(`Je vais vous aider √† d√©poser votre r√©clamation. Veuillez fournir les d√©tails :${complaintForm}`, 'bot');
        }

        /**
         * G√®re la soumission du formulaire de r√©clamation (simulation).
         * Vous devrez impl√©menter l'appel au backend PHP ici.
         * @param {Event} event - L'√©v√©nement de soumission.
         */
        async function submitComplaint(event) {
            event.preventDefault();
            const complaintData = {
                type: document.getElementById('complaintType').value,
                priority: document.getElementById('complaintPriority').value,
                description: document.getElementById('complaintDescription').value,
                user: currentUser ? currentUser.name : 'Utilisateur non connect√©',
                timestamp: new Date().toISOString()
            };

            // Ici, vous enverriez `complaintData` √† votre backend PHP via une requ√™te fetch
            // Exemple :
            /*
            if (isLoggedIn && currentUser) {
                fetch('/chatbot_iam/api/reclamations.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ action: 'fileComplaint', userId: currentUser.id, ...complaintData })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('R√©clamation soumise avec succ√®s !', 'success');
                        addMessage(`üìù Votre r√©clamation de type "${complaintData.type}" avec la priorit√© "${complaintData.priority}" a √©t√© soumise. Nous vous contacterons bient√¥t.`, 'bot');
                    } else {
                        showNotification('Erreur lors de la soumission de la r√©clamation: ' + result.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la soumission de la r√©clamation:', error);
                    showNotification("Erreur de communication avec le serveur pour la r√©clamation.", 'error');
                });
            } else {
                showNotification("Vous devez √™tre connect√© pour soumettre une r√©clamation.", 'warning');
            }
            */

            // Simulation client-side pour le moment si le backend n'est pas pr√™t pour cette fonctionnalit√©
            showNotification('R√©clamation soumise avec succ√®s (simulation) !', 'success');
            addMessage(`üìù Votre r√©clamation de type "${complaintData.type}" avec la priorit√© "${complaintData.priority}" a √©t√© soumise. Nous vous contacterons bient√¥t.`, 'bot');
        }

        /**
         * Bascule la visibilit√© de la barre lat√©rale d'historique et la remplit.
         */
        function toggleHistorySidebar() {
            const historySidebar = document.getElementById('historySidebar');
            historySidebar.classList.toggle('open');

            if (historySidebar.classList.contains('open')) {
                // Remplir l'historique quand la sidebar est ouverte
                fetchConversations();
            }
        }

    </script>
</body>
</html>
